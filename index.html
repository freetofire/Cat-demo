<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatFire App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='9937367' data-sdk='show_9937367'></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
        }
        .main-container { max-width: 480px; margin: 0 auto; }
        .nav-btn { transition: all 0.2s ease-in-out; }
        .nav-btn.active { color: #3b82f6; transform: scale(1.1); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        .task-card { background-color: #1f2937; border: 1px solid #374151; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-secondary { background-color: #374151; }
        #spinner-wheel {
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
            transform-origin: center;
        }
        #aviator-canvas {
            background: linear-gradient(to top, #0f172a, #1e293b);
            border-radius: 0.5rem;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-white">

    <div class="main-container bg-gray-900 min-h-screen flex flex-col">
        <main id="app-content" class="flex-grow p-4 pb-24">
            <!-- Home Page -->
            <div id="home-page" class="page active">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold">Dashboard</h1>
                        <p class="text-sm text-gray-400" id="welcome-message">Welcome!</p>
                    </div>
                    <div id="profile-icon" class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center font-bold text-xl cursor-pointer">
                        <i class="fas fa-user"></i>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg text-center mb-6">
                    <p class="text-gray-400 text-sm">Your Balance</p>
                    <p class="text-3xl font-bold my-2">$<span id="balance-display-home">0.00</span></p>
                    <button id="home-withdraw-btn" class="btn-primary w-full py-2 rounded-lg font-semibold">Withdraw</button>
                </div>

                <!-- Games -->
                <h2 class="font-bold text-xl mb-4">Games</h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div id="aviator-game-card" class="task-card p-4 rounded-lg text-center cursor-pointer hover:bg-gray-700 transition">
                        <i class="fas fa-plane-departure fa-2x text-blue-400 mb-2"></i>
                        <p class="font-semibold">Aviator</p>
                    </div>
                    <div id="spin-game-card" class="task-card p-4 rounded-lg text-center cursor-pointer hover:bg-gray-700 transition">
                        <i class="fas fa-compact-disc fa-2x text-purple-400 mb-2"></i>
                        <p class="font-semibold">Lucky Spin</p>
                    </div>
                </div>

                <!-- Tasks -->
                <h2 class="font-bold text-xl mb-4">Tasks</h2>
                <div class="space-y-4">
                    <div id="daily-tasks-card" class="task-card p-4 rounded-lg flex items-center justify-between cursor-pointer hover:bg-gray-700 transition">
                        <div>
                            <p class="font-semibold text-lg">Daily Tasks</p>
                            <p class="text-sm text-gray-400">Earn rewards every day!</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                    <div id="one-time-tasks-card" class="task-card p-4 rounded-lg flex items-center justify-between cursor-pointer hover:bg-gray-700 transition">
                         <div>
                            <p class="font-semibold text-lg">One-Time Bonus</p>
                            <p class="text-sm text-gray-400">Complete once for a big reward!</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
            </div>

            <!-- Withdraw Page -->
            <div id="withdraw-page" class="page">
                <h1 class="text-2xl font-bold mb-4">Withdraw Funds</h1>
                <div class="bg-blue-900/50 border border-blue-500 text-blue-200 p-3 rounded-lg text-sm mb-6">
                    <strong class="block mb-1">Notice:</strong>
                    <span id="withdraw-hint-text">Minimum withdrawal is $<span id="min-withdraw-amount-display">150</span>. Withdrawals are processed within 24-48 hours.</span>
                </div>

                <div class="space-y-4 mb-6">
                    <input id="withdraw-amount" type="number" placeholder="Enter Amount" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="withdraw-wallet" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="binance">Binance</option>
                        <option value="tonkeeper">Tonkeeper</option>
                    </select>
                    <input id="withdraw-mobile" type="text" placeholder="Mobile Number" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="withdraw-wallet-id" type="text" placeholder="Binance/Tonkeeper ID" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="submit-withdraw-btn" class="btn-primary w-full py-3 rounded-lg font-bold">Submit Request</button>
                
                <h2 class="text-xl font-bold mt-8 mb-4">My Withdrawal History</h2>
                <div id="withdraw-history-container" class="space-y-3">
                    <p class="text-gray-500 text-center">No withdrawal data yet.</p>
                </div>

                <h2 class="text-xl font-bold mt-8 mb-4">Top Withdrawers</h2>
                <div id="top-withdrawers-container" class="space-y-2">
                     <p class="text-gray-500 text-center" id="top-withdraw-loader">Loading...</p>
                </div>
            </div>

            <!-- Refer Page -->
            <div id="refer-page" class="page">
                <h1 class="text-2xl font-bold mb-4">Refer & Earn</h1>
                 <div class="bg-gray-800 p-6 rounded-lg text-center">
                    <i class="fas fa-users fa-3x text-blue-400 mb-4"></i>
                    <p class="text-lg">Invite friends and earn rewards!</p>
                    <p class="text-3xl font-bold my-3">
                        <span id="referral-bonus-referrer-display">$2.00</span> <span class="text-lg font-normal">for you</span>, 
                        <span id="referral-bonus-new-user-display">$2.66</span> <span class="text-lg font-normal">for them</span>
                    </p>
                    <p class="text-gray-400 text-sm mb-6">Share your referral link. When your friend starts the bot via your link, you both get rewards!</p>
                    
                    <div class="bg-red-900/50 border border-red-500 text-red-200 p-2 rounded-lg text-xs mb-4">
                        <strong>Important:</strong> Share the link below. The user must click 'START' in the bot for the referral to work.
                    </div>

                    <div class="bg-gray-900 p-2 rounded-lg flex items-center mb-4">
                        <input id="referral-link" type="text" readonly class="bg-transparent text-gray-300 text-sm w-full outline-none">
                        <button id="copy-link-btn" class="bg-blue-600 px-4 py-2 rounded-lg font-semibold whitespace-nowrap">Copy</button>
                    </div>
                    <button id="share-link-btn" class="btn-primary w-full py-3 rounded-lg font-bold">
                        <i class="fab fa-telegram-plane mr-2"></i> Share on Telegram
                    </button>
                </div>
                <!-- NEW: Referral Stats & History -->
                <div class="mt-8">
                    <h2 class="text-xl font-bold mb-4">Your Referral Stats</h2>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">Total Referrals</p>
                            <p id="ref-stats-count" class="text-2xl font-bold">0</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                             <p class="text-gray-400 text-sm">Referral Earnings</p>
                            <p id="ref-stats-earnings" class="text-2xl font-bold">$0.00</p>
                        </div>
                    </div>
                </div>
                 <div class="mt-8">
                    <h2 class="text-xl font-bold mb-4">Referral History</h2>
                    <div id="referral-history-container" class="space-y-3">
                        <p class="text-gray-500 text-center">You haven't referred anyone yet.</p>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="page">
                <h1 class="text-2xl font-bold mb-6">My Profile</h1>
                <div class="bg-gray-800 p-6 rounded-lg flex items-center space-x-4 mb-6">
                    <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center text-3xl font-bold">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <p id="profile-name" class="text-xl font-semibold">User Name</p>
                        <p id="profile-tg-id" class="text-sm text-gray-400">TG ID: N/A</p>
                    </div>
                </div>
                 <!-- NEW/UPDATED: Profile Stats Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800 p-4 rounded-lg col-span-2">
                        <p class="text-gray-400 text-sm">Total Balance</p>
                        <p id="profile-balance" class="text-2xl font-bold">$0.00</p>
                    </div>
                     <div class="bg-gray-800 p-4 rounded-lg">
                        <p class="text-gray-400 text-sm">Total Earnings</p>
                        <p id="profile-total-earnings" class="text-lg font-bold">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <p class="text-gray-400 text-sm">Total Withdrawn</p>
                        <p id="profile-total-withdrawn" class="text-lg font-bold">$0.00</p>
                    </div>
                     <div class="bg-gray-800 p-4 rounded-lg">
                        <p class="text-gray-400 text-sm">Game Earnings</p>
                        <p id="profile-game-earnings" class="text-lg font-bold">$0.00</p>
                    </div>
                     <div class="bg-gray-800 p-4 rounded-lg">
                        <p class="text-gray-400 text-sm">Referral Earnings</p>
                        <p id="profile-referral-earnings" class="text-lg font-bold">$0.00</p>
                    </div>
                </div>
            </div>
            
            <!-- Daily Tasks Page -->
            <div id="daily-tasks-page" class="page">
                <button class="back-btn mb-4 font-bold"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                <h1 class="text-2xl font-bold mb-6">Daily Tasks</h1>
                <div class="space-y-4">
                    <div class="task-card p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold text-lg">Watch Ads</p>
                                <p class="text-sm text-gray-400">Earn $<span id="ad-reward-display">0.50</span> per ad</p>
                            </div>
                            <button id="watch-ad-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold disabled:bg-gray-500">Watch <span id="ads-left">(10/10)</span></button>
                        </div>
                    </div>
                    <div class="task-card p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold text-lg">Daily Bonus</p>
                                <p class="text-sm text-gray-400">Claim $<span id="daily-bonus-display">0.30</span> every 24 hours</p>
                            </div>
                            <button id="daily-claim-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold disabled:bg-gray-500">Claim</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- One-Time Tasks Page -->
            <div id="one-time-tasks-page" class="page">
                <button class="back-btn mb-4 font-bold"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                <h1 class="text-2xl font-bold mb-6">One-Time Bonus</h1>
                <div class="space-y-4">
                    <div class="task-card p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold text-lg">Join Telegram</p>
                                <p class="text-sm text-gray-400">Join our channel for $<span id="onetime-task-bonus-display-tg">1.00</span></p>
                            </div>
                            <button id="join-telegram-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold disabled:bg-green-600 disabled:text-white transition-all">Join</button>
                        </div>
                    </div>
                    <div class="task-card p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold text-lg">Subscribe to YouTube</p>
                                <p class="text-sm text-gray-400">Subscribe for $<span id="onetime-task-bonus-display-yt">1.00</span></p>
                            </div>
                            <button id="subscribe-youtube-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold disabled:bg-green-600 disabled:text-white transition-all">Subscribe</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aviator Game Page -->
            <div id="aviator-page" class="page">
                <button class="back-btn mb-4 font-bold"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                <h1 class="text-2xl font-bold text-center mb-2">Aviator</h1>
                <div class="relative mb-4">
                    <canvas id="aviator-canvas" width="400" height="300"></canvas>
                    <div id="aviator-multiplier" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl font-bold text-white" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">1.00x</div>
                    <div id="aviator-status" class="absolute top-8 left-1/2 -translate-x-1/2 text-2xl font-bold text-red-500 hidden">CRASHED!</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <div class="flex items-center gap-4 mb-4">
                        <input id="aviator-bet-amount" type="number" value="1" min="1" class="w-full p-2 bg-gray-700 rounded-lg border border-gray-600">
                        <button id="aviator-bet-btn" class="btn-primary w-full py-2 rounded-lg font-bold">Place Bet</button>
                    </div>
                     <p class="text-xs text-center text-gray-400 mb-2">Bet limit: $<span id="aviator-min-bet-display">1</span> - $<span id="aviator-max-bet-display">100</span></p>
                    <button id="aviator-cashout-btn" class="bg-green-600 w-full py-3 rounded-lg font-bold disabled:bg-gray-500" disabled>Cash Out</button>
                </div>
            </div>

            <!-- Spin Game Page -->
            <div id="spin-page" class="page">
                 <button class="back-btn mb-4 font-bold"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                <h1 class="text-2xl font-bold text-center mb-4">Lucky Spin</h1>
                <p class="text-center text-gray-400 mb-6">Costs $<span id="spin-cost-display">1.00</span> per spin</p>
                <div class="relative w-80 h-80 mx-auto mb-6">
                    <div id="spinner-wheel" class="w-full h-full rounded-full border-4 border-blue-500 relative bg-gray-700 overflow-hidden">
                        <!-- Segments will be generated by JS -->
                    </div>
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 w-0 h-0 border-x-8 border-x-transparent border-b-[16px] border-b-red-500 z-10"></div>
                </div>
                <button id="spin-btn" class="btn-primary w-full max-w-xs mx-auto py-3 rounded-lg font-bold flex items-center justify-center disabled:bg-gray-500">Spin the Wheel</button>
            </div>

        </main>

        <!-- Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around" style="max-width: 480px; margin: auto;">
            <button data-page="home-page" class="nav-btn active flex-1 py-3 text-center text-gray-400"><i class="fas fa-home text-2xl"></i><span class="text-xs block">Home</span></button>
            <button data-page="withdraw-page" class="nav-btn flex-1 py-3 text-center text-gray-400"><i class="fas fa-wallet text-2xl"></i><span class="text-xs block">Withdraw</span></button>
            <button data-page="refer-page" class="nav-btn flex-1 py-3 text-center text-gray-400"><i class="fas fa-user-plus text-2xl"></i><span class="text-xs block">Refer</span></button>
            <button data-page="profile-page" class="nav-btn flex-1 py-3 text-center text-gray-400"><i class="fas fa-user-circle text-2xl"></i><span class="text-xs block">Profile</span></button>
        </nav>
    </div>

    <!-- Generic Modal/Popup -->
    <div id="popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg text-center shadow-2xl max-w-sm mx-4">
            <h3 id="popup-title" class="text-xl font-bold mb-2"></h3>
            <p id="popup-message" class="text-gray-300 mb-6"></p>
            <button id="popup-close-btn" class="btn-secondary px-6 py-2 rounded-lg">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, onSnapshot, query, where, writeBatch, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // IMPORTANT: আপনার আসল Firebase কনফিগ দিয়ে প্রতিস্থাপন করুন
        const firebaseConfig = {
            apiKey: "AIzaSyA7vbuDVd49qNePXsNCJrsMVmj-LCSH3R8",
            authDomain: "cat-fire-bot.firebaseapp.com",
            databaseURL: "https://cat-fire-bot-default-rtdb.firebaseio.com",
            projectId: "cat-fire-bot",
            storageBucket: "cat-fire-bot.firebasestorage.app",
            messagingSenderId: "320717959791",
            appId: "1:320717959791:web:8a6d191972cf263a7d939a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        let telegramId;
        let userData = {};
        let adminConfig = {
            minWithdrawAmount: 150, aviatorMinBet: 1, aviatorMaxBet: 100, spinCost: 1, adLimit: 10, adReward: 0.5, dailyBonus: 0.3, oneTimeTaskBonus: 1,
            referralBonusReferrer: 2, referralBonusNewUser: 2.66, withdrawHint: "Withdrawals are processed within 24-48 hours."
        };
        const BOT_USERNAME = "CatFire_Bot"; // IMPORTANT: আপনার বটের ইউজারনেম দিন

        // --- POPUP/MODAL ---
        const popup = document.getElementById('popup');
        function showPopup(title, message) {
            document.getElementById('popup-title').textContent = title;
            document.getElementById('popup-message').innerHTML = message;
            popup.classList.remove('hidden');
            popup.classList.add('flex');
        }
        document.getElementById('popup-close-btn').addEventListener('click', () => { popup.classList.add('hidden'); });

        // --- INITIALIZATION ---
        async function initApp() {
            tg.ready();
            tg.expand();
            
            if (!tg.initDataUnsafe?.user?.id) {
                showPopup("Authentication Error", "Please run this app inside Telegram.");
                document.getElementById('app-content').innerHTML = ''; // Hide content
                return;
            }
            telegramId = tg.initDataUnsafe.user.id.toString();

            await listenToAdminConfig();
            await loadOrCreateUser();
            listenToUserData();
            listenToWithdrawals(); // User's own history
            listenToTopWithdrawers(); // Global top withdrawers
            await handleReferral();
            
            setupEventListeners();
            navigateTo('home-page');
            const username = tg.initDataUnsafe?.user?.username || 'user';
            document.getElementById('welcome-message').textContent = `Welcome, @${username}!`;
        }
        
        // --- DATA HANDLING ---
        async function loadOrCreateUser() { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }
        async function handleReferral() { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }
        function listenToUserData() {
            onSnapshot(doc(db, "users", telegramId), (doc) => {
                if (doc.exists()) { 
                    userData = doc.data(); 
                    updateUI(); 
                }
            });
        }
        async function listenToAdminConfig() {
            return new Promise(resolve => {
                onSnapshot(doc(db, "admin", "config"), (doc) => {
                    if (doc.exists()) { adminConfig = { ...adminConfig, ...doc.data() }; }
                    updateUI();
                    resolve();
                });
            });
        }

        // --- UI & NAVIGATION ---
        function updateUI() {
            if (!userData || !adminConfig) return;
            
            // ব্যালেন্স আপডেট
            const balance = userData.balance || 0;
            document.getElementById('balance-display-home').textContent = balance.toFixed(2);
            
            // প্রোফাইল পেজ আপডেট
            document.getElementById('profile-name').textContent = `${userData.telegram?.firstName || 'User'} ${userData.telegram?.lastName || ''}`;
            document.getElementById('profile-tg-id').textContent = `TG ID: ${userData.telegram?.id || 'N/A'}`;
            document.getElementById('profile-balance').textContent = `$${balance.toFixed(2)}`;

            // NEW: প্রোফাইল পরিসংখ্যান গণনা এবং আপডেট
            const gameEarnings = userData.earnings?.games || 0;
            const taskEarnings = userData.earnings?.tasks || 0;
            const referralEarnings = userData.earnings?.referrals || 0;
            const totalEarnings = gameEarnings + taskEarnings + referralEarnings;
            const totalWithdrawn = userData.totalWithdrawn || 0;

            document.getElementById('profile-total-earnings').textContent = `$${totalEarnings.toFixed(2)}`;
            document.getElementById('profile-game-earnings').textContent = `$${gameEarnings.toFixed(2)}`;
            document.getElementById('profile-referral-earnings').textContent = `$${referralEarnings.toFixed(2)}`;
            document.getElementById('profile-total-withdrawn').textContent = `$${totalWithdrawn.toFixed(2)}`;

            // রেফারেল লিঙ্ক এবং পরিসংখ্যান আপডেট
            if (userData.telegram?.id) {
                document.getElementById('referral-link').value = `https://t.me/${BOT_USERNAME}?start=${userData.telegram.id}`;
            }
            const refCount = userData.referrals?.referredCount || 0;
            document.getElementById('ref-stats-count').textContent = refCount;
            document.getElementById('ref-stats-earnings').textContent = `$${referralEarnings.toFixed(2)}`;
            renderReferralHistory();

            // অ্যাডমিন কনফিগ থেকে UI আপডেট
            document.getElementById('min-withdraw-amount-display').textContent = adminConfig.minWithdrawAmount;
            document.getElementById('withdraw-hint-text').textContent = adminConfig.withdrawHint;
            document.getElementById('ad-reward-display').textContent = adminConfig.adReward.toFixed(2);
            document.getElementById('daily-bonus-display').textContent = adminConfig.dailyBonus.toFixed(2);
            document.getElementById('onetime-task-bonus-display-tg').textContent = adminConfig.oneTimeTaskBonus.toFixed(2);
            document.getElementById('onetime-task-bonus-display-yt').textContent = adminConfig.oneTimeTaskBonus.toFixed(2);
            document.getElementById('referral-bonus-referrer-display').textContent = `$${adminConfig.referralBonusReferrer.toFixed(2)}`;
            document.getElementById('referral-bonus-new-user-display').textContent = `$${adminConfig.referralBonusNewUser.toFixed(2)}`;
            document.getElementById('spin-cost-display').textContent = adminConfig.spinCost.toFixed(2);
            document.getElementById('aviator-min-bet-display').textContent = adminConfig.aviatorMinBet;
            document.getElementById('aviator-max-bet-display').textContent = adminConfig.aviatorMaxBet;
            document.getElementById('aviator-bet-amount').min = adminConfig.aviatorMinBet;
            document.getElementById('aviator-bet-amount').max = adminConfig.aviatorMaxBet;

            // টাস্ক বাটনগুলোর অবস্থা আপডেট
            const adsWatched = getAdsWatchedToday();
            document.getElementById('ads-left').textContent = `(${adminConfig.adLimit - adsWatched}/${adminConfig.adLimit})`;
            document.getElementById('watch-ad-btn').disabled = adsWatched >= adminConfig.adLimit;
            
            const claimedToday = hasClaimedDailyBonus();
            document.getElementById('daily-claim-btn').disabled = claimedToday;
            document.getElementById('daily-claim-btn').textContent = claimedToday ? "Claimed" : "Claim";
            
            updateTaskButton(document.getElementById('join-telegram-btn'), userData.tasks?.joinedTelegram);
            updateTaskButton(document.getElementById('subscribe-youtube-btn'), userData.tasks?.subscribedYouTube);
        }

        function navigateTo(pageId) { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }
        function setupEventListeners() { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }

        // --- NEW: রেফারেল ইতিহাস রেন্ডার ---
        function renderReferralHistory() {
            const container = document.getElementById('referral-history-container');
            const history = userData.referrals?.list || [];
            if (history.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center">You haven't referred anyone yet.</p>`;
                return;
            }
            container.innerHTML = history.reverse().map(ref => {
                const date = ref.timestamp ? ref.timestamp.toDate().toLocaleDateString() : 'N/A';
                return `<div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">@${ref.username || 'Unknown User'}</p>
                                <p class="text-xs text-gray-400">ID: ${ref.id}</p>
                            </div>
                            <span class="text-sm text-gray-400">${date}</span>
                        </div>`;
            }).join('');
        }

        // --- CORE LOGIC (Tasks, Withdraw, Refer) ---
        function watchAd() { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }
        async function claimDailyBonus() { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }
        async function submitWithdrawal() {
             const amount = parseFloat(document.getElementById('withdraw-amount').value);
             if (isNaN(amount) || amount < adminConfig.minWithdrawAmount) { showPopup("Error", `Minimum withdrawal is $${adminConfig.minWithdrawAmount}.`); return; }
             if (amount > userData.balance) { showPopup("Error", "Insufficient balance."); return; }
             
             await updateUserBalance(-amount, null, "Withdrawal request");
             await updateDoc(doc(db, "users", telegramId), { totalWithdrawn: (userData.totalWithdrawn || 0) + amount }); // Update total withdrawn
             await addDoc(collection(db, "withdrawals"), {
                 telegramId: userData.telegram.id, telegramUsername: userData.telegram?.username, amount: amount,
                 wallet: document.getElementById('withdraw-wallet').value, mobile: document.getElementById('withdraw-mobile').value,
                 walletId: document.getElementById('withdraw-wallet-id').value, status: 'pending', timestamp: serverTimestamp()
             });
             showPopup("Success", "Withdrawal request submitted.");
             navigateTo('home-page');
        }
        function copyReferralLink() { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }
        function shareReferralLink() { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }

        // --- [FIXED] Lucky Spin Game ---
        const spinOutcomes = [
            { value: 2, label: '$2', color: '#10b981' }, { value: -2, label: '-$2', color: '#ef4444' }, { value: 5, label: '$5', color: '#3b82f6' },
            { value: 0, label: '$0', color: '#6b7280' }, { value: 100, label: '$100', color: '#f59e0b' }, { value: 0, label: '$0', color: '#6b7280' }
        ];
        const spinner = document.getElementById('spinner-wheel');
        let isSpinning = false;
        
        function createWheel() {
            const segmentAngle = 360 / spinOutcomes.length;
            let html = '';
            spinOutcomes.forEach((outcome, index) => {
                const rotation = index * segmentAngle;
                html += `<div class="absolute w-1/2 h-1/2 origin-bottom-right" style="transform: rotate(${rotation}deg);">
                            <div class="w-full h-full" style="clip-path: polygon(0 0, 100% 0, 100% 100%); background-color: ${outcome.color};">
                                <div class="absolute w-full h-full flex items-center justify-center" style="transform: rotate(${segmentAngle / 2}deg) translate(-25%, -25%);">
                                    <span class="text-white font-bold text-lg">${outcome.label}</span>
                                </div>
                            </div>
                         </div>`;
            });
            spinner.innerHTML = html;
        }

        async function startSpin() {
            if (isSpinning || userData.balance < adminConfig.spinCost) {
                showPopup("Can't Spin", `You need at least $${adminConfig.spinCost.toFixed(2)} to spin.`);
                return;
            }
            isSpinning = true;
            document.getElementById('spin-btn').disabled = true;
            await updateUserBalance(-adminConfig.spinCost, 'games', 'Spin cost');
            
            const outcomeIndex = Math.floor(Math.random() * spinOutcomes.length);
            const outcome = spinOutcomes[outcomeIndex].value;

            const segmentAngle = 360 / spinOutcomes.length;
            const randomOffset = (Math.random() - 0.5) * (segmentAngle * 0.8);
            const targetRotation = (360 * 6) - (outcomeIndex * segmentAngle) - randomOffset;
            
            spinner.style.transform = `rotate(${targetRotation}deg)`;
            
            setTimeout(async () => {
                if (outcome !== 0) {
                    await updateUserBalance(outcome, 'games', `Spin result of ${outcome}`);
                }
                const message = outcome > 0 ? `You won $${outcome.toFixed(2)}!` : (outcome < 0 ? `You lost $${Math.abs(outcome).toFixed(2)}` : "Better luck next time!");
                showPopup(outcome > 0 ? "You Won!" : (outcome < 0 ? "Unlucky!" : "Try Again!"), message);
                isSpinning = false;
                document.getElementById('spin-btn').disabled = false;
            }, 5100);
        }
        
        // --- [IMPROVED] Aviator Game ---
        const canvas = document.getElementById('aviator-canvas');
        const ctx = canvas.getContext('2d');
        let plane = { x: 20, y: canvas.height - 30, angle: -Math.PI / 8 };
        let stars = [];
        let multiplier = 1.00, gameRunning = false, crashed = false, crashMultiplier, animationFrameId;
        const betBtn = document.getElementById('aviator-bet-btn'), cashoutBtn = document.getElementById('aviator-cashout-btn');
        const statusEl = document.getElementById('aviator-status'), multiplierEl = document.getElementById('aviator-multiplier');

        function initAviatorAssets() {
            stars = [];
            for (let i = 0; i < 100; i++) {
                stars.push({
                    x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                    radius: Math.random() * 1.5
                });
            }
        }

        function drawAviatorBackground() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            stars.forEach(star => {
                star.x -= 0.2; // Move stars to the left
                if (star.x < 0) star.x = canvas.width;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function drawPlane() {
            drawAviatorBackground();
            ctx.save();
            ctx.translate(plane.x, plane.y);
            ctx.rotate(plane.angle);
            ctx.fillStyle = '#f0f0f0';
            ctx.font = '24px "Font Awesome 6 Free"';
            ctx.fillText('\uf072', -15, 10); // Plane icon
            ctx.restore();
        }

        function drawCrash() {
            ctx.fillStyle = 'red';
            ctx.font = '30px "Font Awesome 6 Free"';
            ctx.fillText('\uf1e2', plane.x, plane.y); // Bomb/explosion icon
        }

        function aviatorLoop() {
            if (!gameRunning) return;
            
            // গ্রাফের মতো দেখতে কার্ভ তৈরি
            multiplier += 0.01 * Math.log1p(multiplier);
            plane.x += 1;
            plane.y -= Math.log1p(multiplier) * 0.4;
            
            if (plane.y < 50) plane.angle = Math.max(-Math.PI / 16, plane.angle - 0.001);

            if (multiplier >= crashMultiplier) {
                gameRunning = false; crashed = true;
                statusEl.textContent = `CRASHED @ ${crashMultiplier.toFixed(2)}x`;
                statusEl.classList.remove('hidden');
                betBtn.disabled = false; betBtn.textContent = "Place Bet"; cashoutBtn.disabled = true;
                drawCrash(); cancelAnimationFrame(animationFrameId); return;
            }
            
            multiplierEl.textContent = `${multiplier.toFixed(2)}x`;
            drawPlane();
            animationFrameId = requestAnimationFrame(aviatorLoop);
        }

        async function placeAviatorBet() { /* আগের মতোই আছে, শুধু শুরুটা একটু ভিন্ন */
            const betAmount = parseFloat(document.getElementById('aviator-bet-amount').value);
            // ... (validation is same)
            await updateUserBalance(-betAmount, 'games', 'Aviator bet');
            betBtn.disabled = true; betBtn.textContent = "Flying..."; cashoutBtn.disabled = false; statusEl.classList.add('hidden');
            
            gameRunning = true; crashed = false; multiplier = 1.00; 
            plane = { x: 20, y: canvas.height - 30, angle: -Math.PI/8 }; 
            crashMultiplier = (Math.random() * 10) + 1.1; // Simplified crash point
            setTimeout(() => { aviatorLoop(); }, 1000);
        }
        async function cashoutAviator() { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }

        // --- HELPERS & DATA LISTENERS ---
        function getAdsWatchedToday() { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }
        function hasClaimedDailyBonus() { /* আগের মতোই আছে, কোনো পরিবর্তন নেই */ }
        async function updateUserBalance(amount, type, description) {
            const userRef = doc(db, "users", telegramId);
            const newBalance = (userData.balance || 0) + amount;
            const updateData = { balance: newBalance < 0 ? 0 : newBalance };
            if (type) { updateData[`earnings.${type}`] = (userData.earnings?.[type] || 0) + amount; }
            await updateDoc(userRef, updateData);
        }
        
        // [FIXED] নিজের উইথড্র ইতিহাস দেখা
        function listenToWithdrawals() {
            const q = query(collection(db, "withdrawals"), where("telegramId", "==", Number(telegramId)), orderBy("timestamp", "desc"), limit(10));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('withdraw-history-container');
                if (snapshot.empty) {
                    container.innerHTML = `<p class="text-gray-500 text-center">No withdrawal data yet.</p>`;
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const statusColors = { pending: 'text-yellow-400', approved: 'text-green-400', rejected: 'text-red-400' };
                    return `<div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-bold">$${data.amount.toFixed(2)}</p>
                                    <p class="text-xs text-gray-400">${data.walletId}</p>
                                </div>
                                <span class="capitalize text-sm font-semibold ${statusColors[data.status] || 'text-gray-400'}">${data.status}</span>
                            </div>`;
                }).join('');
            });
        }
        
        // [FIXED] টপ উইথড্রয়ারদের তালিকা লোড করা
        function listenToTopWithdrawers() {
            const topWithdrawersRef = doc(db, "admin", "topWithdrawers");
            onSnapshot(topWithdrawersRef, (doc) => {
                const container = document.getElementById('top-withdrawers-container');
                if (!doc.exists() || !doc.data().list || doc.data().list.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center">No data available.</p>`;
                    return;
                }
                const list = doc.data().list;
                container.innerHTML = list.map((item, index) => `
                    <div class="flex items-center space-x-3 bg-gray-800 p-2 rounded-lg">
                        <span class="font-bold text-sm w-6 text-center">${index + 1}</span>
                        <i class="fas fa-user-circle text-blue-400"></i>
                        <span class="flex-grow font-semibold">${item.name}</span>
                        <span class="text-green-400 font-bold">$${item.amount}</span>
                    </div>
                `).join('');
            });
        }

        window.addEventListener('load', () => { initApp(); createWheel(); initAviatorAssets(); drawPlane(); });
    </script>
</body>
</html>

