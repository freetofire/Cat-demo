<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatFire App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='9937367' data-sdk='show_9937367'></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
        }
        .main-container { max-width: 480px; margin: 0 auto; }
        .nav-btn { transition: all 0.2s ease-in-out; }
        .nav-btn.active { color: #3b82f6; transform: scale(1.1); }
        .page { display: none; }
        .page.active { display: block; }
        .task-card { background-color: #1f2937; border: 1px solid #374151; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-secondary { background-color: #374151; }
        #spinner {
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
            transform-origin: center;
        }
        #aviator-canvas {
            background: linear-gradient(to top, #1f2937, #374151);
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="text-white">

    <div class="main-container bg-gray-900 min-h-screen flex flex-col">
        <main id="app-content" class="flex-grow p-4 pb-24">
            <!-- Home Page -->
            <div id="home-page" class="page active">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold">Dashboard</h1>
                        <p class="text-sm text-gray-400" id="welcome-message">Welcome!</p>
                    </div>
                    <div id="profile-icon" class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center font-bold text-xl cursor-pointer">
                        <i class="fas fa-user"></i>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg text-center mb-6">
                    <p class="text-gray-400 text-sm">Your Balance</p>
                    <p class="text-3xl font-bold my-2">$<span id="balance-display-home">0.00</span></p>
                    <button id="home-withdraw-btn" class="btn-primary w-full py-2 rounded-lg font-semibold">Withdraw</button>
                </div>

                <!-- Games -->
                <h2 class="font-bold text-xl mb-4">Games</h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div id="aviator-game-card" class="task-card p-4 rounded-lg text-center cursor-pointer hover:bg-gray-700 transition">
                        <i class="fas fa-plane-departure fa-2x text-blue-400 mb-2"></i>
                        <p class="font-semibold">Aviator</p>
                    </div>
                    <div id="spin-game-card" class="task-card p-4 rounded-lg text-center cursor-pointer hover:bg-gray-700 transition">
                        <i class="fas fa-compact-disc fa-2x text-purple-400 mb-2"></i>
                        <p class="font-semibold">Lucky Spin</p>
                    </div>
                </div>

                <!-- Tasks -->
                <h2 class="font-bold text-xl mb-4">Tasks</h2>
                <div class="space-y-4">
                    <div id="daily-tasks-card" class="task-card p-4 rounded-lg flex items-center justify-between cursor-pointer hover:bg-gray-700 transition">
                        <div>
                            <p class="font-semibold text-lg">Daily Tasks</p>
                            <p class="text-sm text-gray-400">Earn rewards every day!</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                    <div id="one-time-tasks-card" class="task-card p-4 rounded-lg flex items-center justify-between cursor-pointer hover:bg-gray-700 transition">
                         <div>
                            <p class="font-semibold text-lg">One-Time Bonus</p>
                            <p class="text-sm text-gray-400">Complete once for a big reward!</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
            </div>

            <!-- Withdraw Page -->
            <div id="withdraw-page" class="page">
                <h1 class="text-2xl font-bold mb-4">Withdraw Funds</h1>
                <div class="bg-blue-900/50 border border-blue-500 text-blue-200 p-3 rounded-lg text-sm mb-6">
                    <strong class="block mb-1">Notice:</strong>
                    <span id="withdraw-hint-text">Minimum withdrawal is $<span id="min-withdraw-amount-display">150</span>. Withdrawals are processed within 24-48 hours.</span>
                </div>

                <div class="space-y-4 mb-6">
                    <input id="withdraw-amount" type="number" placeholder="Enter Amount" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="withdraw-wallet" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="binance">Binance</option>
                        <option value="tonkeeper">Tonkeeper</option>
                    </select>
                    <input id="withdraw-mobile" type="text" placeholder="Mobile Number" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="withdraw-wallet-id" type="text" placeholder="Binance/Tonkeeper ID" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="submit-withdraw-btn" class="btn-primary w-full py-3 rounded-lg font-bold">Submit Request</button>
                
                <h2 class="text-xl font-bold mt-8 mb-4">My Withdrawal History</h2>
                <div id="withdraw-history-container" class="space-y-3">
                    <p class="text-gray-500 text-center">No withdrawal data yet.</p>
                </div>

                <h2 class="text-xl font-bold mt-8 mb-4">Top Withdrawers</h2>
                <div id="top-withdrawers-container" class="space-y-2">
                     <p class="text-gray-500 text-center">Loading...</p>
                </div>
            </div>

            <!-- Refer Page -->
            <div id="refer-page" class="page">
                <h1 class="text-2xl font-bold mb-4">Refer & Earn</h1>
                 <div class="bg-gray-800 p-6 rounded-lg text-center">
                    <i class="fas fa-users fa-3x text-blue-400 mb-4"></i>
                    <p class="text-lg">Invite friends and earn rewards!</p>
                    <p class="text-3xl font-bold my-3">
                        <span id="referral-bonus-referrer-display">$2.00</span> <span class="text-lg font-normal">for you</span>, 
                        <span id="referral-bonus-new-user-display">$2.66</span> <span class="text-lg font-normal">for them</span>
                    </p>
                    <p class="text-gray-400 text-sm mb-6">Share your referral link. When your friend starts the bot via your link, you both get rewards!</p>
                    
                    <div class="bg-red-900/50 border border-red-500 text-red-200 p-2 rounded-lg text-xs mb-4">
                        <strong>Important:</strong> Share the link below. The user must click 'START' in the bot for the referral to work.
                    </div>

                    <div class="bg-gray-900 p-2 rounded-lg flex items-center mb-4">
                        <input id="referral-link" type="text" readonly class="bg-transparent text-gray-300 text-sm w-full outline-none">
                        <button id="copy-link-btn" class="bg-blue-600 px-4 py-2 rounded-lg font-semibold whitespace-nowrap">Copy</button>
                    </div>
                    <button id="share-link-btn" class="btn-primary w-full py-3 rounded-lg font-bold">
                        <i class="fab fa-telegram-plane mr-2"></i> Share on Telegram
                    </button>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="page">
                <h1 class="text-2xl font-bold mb-6">My Profile</h1>
                <div class="bg-gray-800 p-6 rounded-lg flex items-center space-x-4 mb-6">
                    <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center text-3xl font-bold">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <p id="profile-name" class="text-xl font-semibold">User Name</p>
                        <p id="profile-tg-id" class="text-sm text-gray-400">TG ID: N/A</p>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400">Total Balance</p>
                    <p id="profile-balance" class="text-2xl font-bold">$0.00</p>
                </div>
            </div>
            
            <!-- Daily Tasks Page -->
            <div id="daily-tasks-page" class="page">
                <button class="back-btn mb-4 font-bold"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                <h1 class="text-2xl font-bold mb-6">Daily Tasks</h1>
                <div class="space-y-4">
                    <div class="task-card p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold text-lg">Watch Ads</p>
                                <p class="text-sm text-gray-400">Earn $<span id="ad-reward-display">0.50</span> per ad</p>
                            </div>
                            <button id="watch-ad-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold disabled:bg-gray-500">Watch <span id="ads-left">(10/10)</span></button>
                        </div>
                    </div>
                    <div class="task-card p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold text-lg">Daily Bonus</p>
                                <p class="text-sm text-gray-400">Claim $<span id="daily-bonus-display">0.30</span> every 24 hours</p>
                            </div>
                            <button id="daily-claim-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold disabled:bg-gray-500">Claim</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- One-Time Tasks Page -->
            <div id="one-time-tasks-page" class="page">
                <button class="back-btn mb-4 font-bold"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                <h1 class="text-2xl font-bold mb-6">One-Time Bonus</h1>
                <div class="space-y-4">
                    <div class="task-card p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold text-lg">Join Telegram</p>
                                <p class="text-sm text-gray-400">Join our channel for $<span id="onetime-task-bonus-display-tg">1.00</span></p>
                            </div>
                            <button id="join-telegram-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold disabled:bg-green-600 disabled:text-white transition-all">Join</button>
                        </div>
                    </div>
                    <div class="task-card p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold text-lg">Subscribe to YouTube</p>
                                <p class="text-sm text-gray-400">Subscribe for $<span id="onetime-task-bonus-display-yt">1.00</span></p>
                            </div>
                            <button id="subscribe-youtube-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold disabled:bg-green-600 disabled:text-white transition-all">Subscribe</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aviator Game Page -->
            <div id="aviator-page" class="page">
                <button class="back-btn mb-4 font-bold"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                <h1 class="text-2xl font-bold text-center mb-2">Aviator</h1>
                <div class="relative mb-4">
                    <canvas id="aviator-canvas" width="400" height="300"></canvas>
                    <div id="aviator-multiplier" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl font-bold text-white" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">1.00x</div>
                    <div id="aviator-status" class="absolute top-8 left-1/2 -translate-x-1/2 text-2xl font-bold text-red-500 hidden">CRASHED!</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <div class="flex items-center gap-4 mb-4">
                        <input id="aviator-bet-amount" type="number" value="1" min="1" class="w-full p-2 bg-gray-700 rounded-lg border border-gray-600">
                        <button id="aviator-bet-btn" class="btn-primary w-full py-2 rounded-lg font-bold">Place Bet</button>
                    </div>
                     <p class="text-xs text-center text-gray-400 mb-2">Bet limit: $<span id="aviator-min-bet-display">1</span> - $<span id="aviator-max-bet-display">100</span></p>
                    <button id="aviator-cashout-btn" class="bg-green-600 w-full py-3 rounded-lg font-bold disabled:bg-gray-500" disabled>Cash Out</button>
                </div>
            </div>

            <!-- Spin Game Page -->
            <div id="spin-page" class="page">
                 <button class="back-btn mb-4 font-bold"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                <h1 class="text-2xl font-bold text-center mb-4">Lucky Spin</h1>
                <p class="text-center text-gray-400 mb-6">Costs $<span id="spin-cost-display">1.00</span> per spin</p>
                <div class="relative w-80 h-80 mx-auto mb-6">
                    <div id="spinner" class="w-full h-full rounded-full border-4 border-blue-500 relative">
                        <!-- Segments will be generated by JS -->
                    </div>
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 w-0 h-0 border-x-8 border-x-transparent border-b-[16px] border-b-red-500"></div>
                </div>
                <button id="spin-btn" class="btn-primary w-full max-w-xs mx-auto py-3 rounded-lg font-bold flex items-center justify-center disabled:bg-gray-500">Spin the Wheel</button>
            </div>

        </main>

        <!-- Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around max-w-480px mx-auto">
            <button data-page="home-page" class="nav-btn active flex-1 py-3 text-center text-gray-400"><i class="fas fa-home text-2xl"></i><span class="text-xs block">Home</span></button>
            <button data-page="withdraw-page" class="nav-btn flex-1 py-3 text-center text-gray-400"><i class="fas fa-wallet text-2xl"></i><span class="text-xs block">Withdraw</span></button>
            <button data-page="refer-page" class="nav-btn flex-1 py-3 text-center text-gray-400"><i class="fas fa-user-plus text-2xl"></i><span class="text-xs block">Refer</span></button>
            <button data-page="profile-page" class="nav-btn flex-1 py-3 text-center text-gray-400"><i class="fas fa-user-circle text-2xl"></i><span class="text-xs block">Profile</span></button>
        </nav>
    </div>

    <!-- Generic Modal/Popup -->
    <div id="popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg text-center shadow-2xl max-w-sm mx-4">
            <h3 id="popup-title" class="text-xl font-bold mb-2"></h3>
            <p id="popup-message" class="text-gray-300 mb-6"></p>
            <button id="popup-close-btn" class="btn-secondary px-6 py-2 rounded-lg">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, onSnapshot, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA7vbuDVd49qNePXsNCJrsMVmj-LCSH3R8",
            authDomain: "cat-fire-bot.firebaseapp.com",
            databaseURL: "https://cat-fire-bot-default-rtdb.firebaseio.com",
            projectId: "cat-fire-bot",
            storageBucket: "cat-fire-bot.firebasestorage.app",
            messagingSenderId: "320717959791",
            appId: "1:320717959791:web:8a6d191972cf263a7d939a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        let telegramId;
        let userData = {};
        // Default config, will be overwritten by Firestore
        let adminConfig = {
            minWithdrawAmount: 150,
            aviatorMinBet: 1,
            aviatorMaxBet: 100,
            spinCost: 1,
            adLimit: 10,
            adReward: 0.5,
            dailyBonus: 0.3,
            oneTimeTaskBonus: 1,
            referralBonusReferrer: 2,
            referralBonusNewUser: 2.66,
            withdrawHint: "Withdrawals are processed within 24-48 hours."
        };
        const BOT_USERNAME = "CatFire_Bot"; // Replace with your bot's username

        // --- POPUP/MODAL ---
        const popup = document.getElementById('popup');
        function showPopup(title, message) {
            document.getElementById('popup-title').textContent = title;
            document.getElementById('popup-message').innerHTML = message;
            popup.classList.remove('hidden');
            popup.classList.add('flex');
        }
        document.getElementById('popup-close-btn').addEventListener('click', () => { popup.classList.add('hidden'); });

        // --- INITIALIZATION ---
        async function initApp() {
            tg.ready();
            tg.expand();
            
            if (!tg.initDataUnsafe?.user?.id) {
                showPopup("Authentication Error", "Please run this app inside Telegram.");
                return;
            }
            telegramId = tg.initDataUnsafe.user.id.toString();

            await listenToAdminConfig(); // Load config first to prevent issues
            await loadOrCreateUser();
            listenToUserData();
            listenToWithdrawals();
            listenToTopWithdrawers();
            await handleReferral();
            
            setupEventListeners();
            navigateTo('home-page');
            const username = tg.initDataUnsafe?.user?.username || 'user';
            document.getElementById('welcome-message').textContent = `Welcome, @${username}!`;
        }
        
        // --- DATA HANDLING ---
        async function loadOrCreateUser() {
            const userRef = doc(db, "users", telegramId);
            const userSnap = await getDoc(userRef);

            if (!userSnap.exists()) {
                const newUser = {
                    telegram: { id: tg.initDataUnsafe.user.id, username: tg.initDataUnsafe.user.username || 'Guest', firstName: tg.initDataUnsafe.user.first_name || 'New', lastName: tg.initDataUnsafe.user.last_name || 'User', },
                    balance: 0.00,
                    earnings: { games: 0, tasks: 0, referrals: 0 },
                    tasks: { dailyClaimedAt: null, adsWatchedToday: 0, lastAdWatchedAt: null, joinedTelegram: false, subscribedYouTube: false },
                    referrals: { referrer: null, referredCount: 0, list: [] },
                    createdAt: serverTimestamp()
                };
                await setDoc(userRef, newUser);
                userData = newUser;
            } else {
                userData = userSnap.data();
            }
        }

        async function handleReferral() {
            const startParam = tg.initDataUnsafe?.start_param;
            if (startParam && !userData.referrals.referrer && startParam !== telegramId) {
                const referrerRef = doc(db, "users", startParam);
                const referrerSnap = await getDoc(referrerRef);

                if (referrerSnap.exists()) {
                    const batch = writeBatch(db);
                    const referrerData = referrerSnap.data();
                    
                    // Update new user
                    batch.update(doc(db, "users", telegramId), {
                        'referrals.referrer': startParam,
                        'balance': (userData.balance || 0) + adminConfig.referralBonusNewUser,
                        'earnings.referrals': (userData.earnings?.referrals || 0) + adminConfig.referralBonusNewUser
                    });

                    // Update referrer
                    batch.update(referrerRef, {
                        'balance': (referrerData.balance || 0) + adminConfig.referralBonusReferrer,
                        'earnings.referrals': (referrerData.earnings?.referrals || 0) + adminConfig.referralBonusReferrer,
                        'referrals.referredCount': (referrerData.referrals?.referredCount || 0) + 1,
                        'referrals.list': [...(referrerData.referrals?.list || []), { id: telegramId, username: tg.initDataUnsafe?.user?.username || 'Unknown', timestamp: serverTimestamp() }]
                    });

                    await batch.commit();
                    showPopup("Referral Success!", `You've got $${adminConfig.referralBonusNewUser.toFixed(2)}, and your friend got $${adminConfig.referralBonusReferrer.toFixed(2)}!`);
                }
            }
        }

        function listenToUserData() {
            onSnapshot(doc(db, "users", telegramId), (doc) => {
                if (doc.exists()) { userData = doc.data(); updateUI(); }
            });
        }
        
        async function listenToAdminConfig() {
             return new Promise(resolve => {
                onSnapshot(doc(db, "admin", "config"), (doc) => {
                    if (doc.exists()) { adminConfig = { ...adminConfig, ...doc.data() }; }
                    updateUI();
                    resolve();
                });
            });
        }

        // --- UI & NAVIGATION ---
        function updateUI() {
            if (!userData || !adminConfig) return;
            
            const balance = userData.balance || 0;
            document.getElementById('balance-display-home').textContent = balance.toFixed(2);
            document.getElementById('profile-balance').textContent = `$${balance.toFixed(2)}`;
            
            document.getElementById('profile-name').textContent = `${userData.telegram?.firstName || 'User'} ${userData.telegram?.lastName || ''}`;
            document.getElementById('profile-tg-id').textContent = `TG ID: ${userData.telegram?.id || 'N/A'}`;

            // [FIXED] Correct referral link format for bot start
            if (userData.telegram?.id) {
                document.getElementById('referral-link').value = `https://t.me/${BOT_USERNAME}?start=${userData.telegram.id}`;
            }
            
            // Update UI with admin-controlled values
            document.getElementById('min-withdraw-amount-display').textContent = adminConfig.minWithdrawAmount;
            document.getElementById('withdraw-hint-text').textContent = adminConfig.withdrawHint;
            document.getElementById('ad-reward-display').textContent = adminConfig.adReward.toFixed(2);
            document.getElementById('daily-bonus-display').textContent = adminConfig.dailyBonus.toFixed(2);
            document.getElementById('onetime-task-bonus-display-tg').textContent = adminConfig.oneTimeTaskBonus.toFixed(2);
            document.getElementById('onetime-task-bonus-display-yt').textContent = adminConfig.oneTimeTaskBonus.toFixed(2);
            document.getElementById('referral-bonus-referrer-display').textContent = `$${adminConfig.referralBonusReferrer.toFixed(2)}`;
            document.getElementById('referral-bonus-new-user-display').textContent = `$${adminConfig.referralBonusNewUser.toFixed(2)}`;
            document.getElementById('spin-cost-display').textContent = adminConfig.spinCost.toFixed(2);
            document.getElementById('aviator-min-bet-display').textContent = adminConfig.aviatorMinBet;
            document.getElementById('aviator-max-bet-display').textContent = adminConfig.aviatorMaxBet;
            document.getElementById('aviator-bet-amount').min = adminConfig.aviatorMinBet;
            document.getElementById('aviator-bet-amount').max = adminConfig.aviatorMaxBet;
            document.getElementById('aviator-bet-amount').value = Math.max(adminConfig.aviatorMinBet, 1);


            // Daily Tasks Status
            const adsWatched = getAdsWatchedToday();
            document.getElementById('ads-left').textContent = `(${adminConfig.adLimit - adsWatched}/${adminConfig.adLimit})`;
            document.getElementById('watch-ad-btn').disabled = adsWatched >= adminConfig.adLimit;
            
            const claimedToday = hasClaimedDailyBonus();
            document.getElementById('daily-claim-btn').disabled = claimedToday;
            document.getElementById('daily-claim-btn').textContent = claimedToday ? "Claimed" : "Claim";
            
            // One-Time Tasks Status
            updateTaskButton(document.getElementById('join-telegram-btn'), userData.tasks?.joinedTelegram, 'Join', 'Claim', 'Claimed');
            updateTaskButton(document.getElementById('subscribe-youtube-btn'), userData.tasks?.subscribedYouTube, 'Subscribe', 'Claim', 'Claimed');
        }

        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.page === pageId);
            });
            window.scrollTo(0, 0);
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-btn, .back-btn, #profile-icon, #home-withdraw-btn, #aviator-game-card, #spin-game-card, #daily-tasks-card, #one-time-tasks-card').forEach(el => {
                el.addEventListener('click', (e) => {
                    const targetPage = e.currentTarget.dataset.page || (e.currentTarget.classList.contains('back-btn') ? 'home-page' : null);
                    if(targetPage) navigateTo(targetPage);
                    else { // Handle non-page navigation clicks
                        const id = e.currentTarget.id;
                        if(id === 'profile-icon') navigateTo('profile-page');
                        if(id === 'home-withdraw-btn') navigateTo('withdraw-page');
                        if(id === 'aviator-game-card') navigateTo('aviator-page');
                        if(id === 'spin-game-card') navigateTo('spin-page');
                        if(id === 'daily-tasks-card') navigateTo('daily-tasks-page');
                        if(id === 'one-time-tasks-card') navigateTo('one-time-tasks-page');
                    }
                });
            });

            document.getElementById('submit-withdraw-btn').addEventListener('click', submitWithdrawal);
            document.getElementById('copy-link-btn').addEventListener('click', copyReferralLink);
            document.getElementById('share-link-btn').addEventListener('click', shareReferralLink);
            document.getElementById('watch-ad-btn').addEventListener('click', watchAd);
            document.getElementById('daily-claim-btn').addEventListener('click', claimDailyBonus);
            setupOneTimeTaskHandlers();
            document.getElementById('spin-btn').addEventListener('click', startSpin);
            document.getElementById('aviator-bet-btn').addEventListener('click', placeAviatorBet);
            document.getElementById('aviator-cashout-btn').addEventListener('click', cashoutAviator);
        }

        // --- [NEW] One-Time Tasks Logic (Improved) ---
        function setupOneTimeTaskHandlers() {
            const tasks = [
                { btn: document.getElementById('join-telegram-btn'), url: "https://t.me/catfire_channel", type: 'joinedTelegram' },
                { btn: document.getElementById('subscribe-youtube-btn'), url: "https://www.youtube.com", type: 'subscribedYouTube' } // Replace with actual URL
            ];

            tasks.forEach(task => {
                task.btn.addEventListener('click', async () => {
                    const currentState = task.btn.dataset.state || (userData.tasks?.[task.type] ? 'claimed' : 'initial');

                    if (currentState === 'initial') {
                        if (task.url.startsWith("https://t.me/")) tg.openTelegramLink(task.url);
                        else window.open(task.url, '_blank');

                        task.btn.textContent = 'Verifying...';
                        task.btn.disabled = true;
                        setTimeout(() => {
                            updateTaskButton(task.btn, false, 'Initial', 'Claim', 'Claimed');
                        }, 4000); // 4 second delay
                    } else if (currentState === 'claimable') {
                        if (userData.tasks?.[task.type]) return;
                        await updateUserBalance(adminConfig.oneTimeTaskBonus, 'tasks', `Completed task: ${task.type}`);
                        await updateDoc(doc(db, "users", telegramId), { [`tasks.${task.type}`]: true });
                        showPopup("Success!", `You've earned $${adminConfig.oneTimeTaskBonus.toFixed(2)}.`);
                        updateTaskButton(task.btn, true, 'Initial', 'Claim', 'Claimed');
                    }
                });
            });
        }
        
        function updateTaskButton(btn, isCompleted, initialState, claimableState, claimedState) {
            if (isCompleted) {
                btn.dataset.state = 'claimed';
                btn.textContent = claimedState;
                btn.disabled = true;
                btn.classList.remove('btn-primary', 'bg-green-600');
                btn.classList.add('bg-green-600');
            } else if (btn.dataset.state === 'verifying') {
                // Do nothing, let the verification timer finish
            } else if(btn.dataset.state === 'initial' || btn.textContent === 'Verifying...') {
                 btn.dataset.state = 'claimable';
                 btn.textContent = claimableState;
                 btn.disabled = false;
                 btn.classList.remove('btn-primary');
                 btn.classList.add('bg-green-600');
            } else {
                 btn.dataset.state = 'initial';
                 btn.textContent = initialState;
                 btn.disabled = false;
                 btn.classList.add('btn-primary');
                 btn.classList.remove('bg-green-600');
            }
        }

        // --- CORE LOGIC (Tasks, Withdraw, Refer) ---
        // (Most of this logic is the same, just using adminConfig values now)
        function watchAd() {
            show_9937367().then(async () => {
                showPopup("Success!", `You've earned $${adminConfig.adReward.toFixed(2)} for watching the ad.`);
                await updateUserBalance(adminConfig.adReward, 'tasks', 'Ad watch reward');
                
                const userRef = doc(db, "users", telegramId);
                const adsWatched = getAdsWatchedToday();
                
                if (adsWatched === 0) { // First ad of the day, reset count
                     await updateDoc(userRef, { 'tasks.adsWatchedToday': 1, 'tasks.lastAdWatchedAt': serverTimestamp() });
                } else {
                     await updateDoc(userRef, { 'tasks.adsWatchedToday': adsWatched + 1 });
                }
            }).catch(e => { showPopup("Ad Error", "The ad could not be shown. Please try again later."); });
        }
        async function claimDailyBonus() {
            if(hasClaimedDailyBonus()) return;
            await updateUserBalance(adminConfig.dailyBonus, 'tasks', 'Daily bonus');
            await updateDoc(doc(db, "users", telegramId), { 'tasks.dailyClaimedAt': serverTimestamp() });
            showPopup("Success!", `You've claimed $${adminConfig.dailyBonus.toFixed(2)}!`);
        }
        async function submitWithdrawal() {
             const amount = parseFloat(document.getElementById('withdraw-amount').value);
             if (isNaN(amount) || amount < adminConfig.minWithdrawAmount) { showPopup("Error", `Minimum withdrawal is $${adminConfig.minWithdrawAmount}.`); return; }
             if (amount > userData.balance) { showPopup("Error", "Insufficient balance."); return; }
             
             await updateUserBalance(-amount, null, "Withdrawal request");
             await addDoc(collection(db, "withdrawals"), {
                 telegramId: userData.telegram.id, telegramUsername: userData.telegram?.username, amount: amount,
                 wallet: document.getElementById('withdraw-wallet').value, mobile: document.getElementById('withdraw-mobile').value,
                 walletId: document.getElementById('withdraw-wallet-id').value, status: 'pending', timestamp: serverTimestamp()
             });
             showPopup("Success", "Withdrawal request submitted.");
             navigateTo('home-page');
        }
        function copyReferralLink() { document.getElementById('referral-link').select(); document.execCommand('copy'); showPopup("Copied!", "Link copied."); }
        function shareReferralLink() { tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(document.getElementById('referral-link').value)}&text=${encodeURIComponent("Join and get a bonus!")}`); }

        // --- [FIXED] Lucky Spin Game ---
        const spinOutcomes = [-2, 0, 2, 5, 100];
        const spinner = document.getElementById('spinner');
        let isSpinning = false;
        
        function createWheel() { /* Unchanged from original */ }

        async function startSpin() {
            if (isSpinning || userData.balance < adminConfig.spinCost) return;
            isSpinning = true;
            document.getElementById('spin-btn').disabled = true;
            await updateUserBalance(-adminConfig.spinCost, 'games', 'Spin cost');
            
            // Determine outcome first
            const rand = Math.random() * 100;
            let outcome = (rand < 50) ? 0 : (rand < 84) ? (Math.random() < 0.5 ? 2 : -2) : (rand < 98) ? 5 : 100;
            const outcomeIndex = spinOutcomes.indexOf(outcome);

            // Calculate rotation to land on the correct segment
            const segmentAngle = 360 / spinOutcomes.length;
            const randomOffset = (Math.random() - 0.5) * (segmentAngle * 0.8); // Land somewhere within the segment
            const targetRotation = (360 * 5) - (outcomeIndex * segmentAngle) - randomOffset;
            
            spinner.style.transform = `rotate(${targetRotation}deg)`;
            
            setTimeout(async () => {
                if (outcome !== 0) await updateUserBalance(outcome, 'games', `Spin win of ${outcome}`);
                showPopup(outcome > 0 ? "You Won!" : (outcome < 0 ? "Unlucky!" : "Try Again!"), `You won $${outcome.toFixed(2)}.`);
                isSpinning = false;
                document.getElementById('spin-btn').disabled = false;
            }, 4100);
        }
        
        // --- [IMPROVED] Aviator Game ---
        const canvas = document.getElementById('aviator-canvas');
        const ctx = canvas.getContext('2d');
        let plane = { x: 20, y: canvas.height - 30 };
        let multiplier = 1.00, gameRunning = false, crashed = false, crashMultiplier, animationFrameId;

        const betBtn = document.getElementById('aviator-bet-btn'), cashoutBtn = document.getElementById('aviator-cashout-btn');
        const statusEl = document.getElementById('aviator-status'), multiplierEl = document.getElementById('aviator-multiplier');
        
        function getCrashPoint() { /* Unchanged from original */ }
        function drawPlane() { /* Unchanged from original */ }
        function drawCrash() { /* Unchanged from original */ }

        function aviatorLoop() {
            if (!gameRunning) return;
            
            // [IMPROVED] S-curve growth for multiplier and curved path for plane
            multiplier += 0.01 * Math.pow(multiplier, 0.2); 
            plane.x += 1.2;
            plane.y -= Math.log(multiplier) * 0.6;

            if (multiplier >= crashMultiplier) {
                gameRunning = false; crashed = true;
                statusEl.textContent = `CRASHED @ ${crashMultiplier.toFixed(2)}x`;
                statusEl.classList.remove('hidden'); betBtn.disabled = false; betBtn.textContent = "Place Bet"; cashoutBtn.disabled = true;
                drawCrash(); cancelAnimationFrame(animationFrameId); return;
            }
            
            multiplierEl.textContent = `${multiplier.toFixed(2)}x`;
            drawPlane();
            animationFrameId = requestAnimationFrame(aviatorLoop);
        }

        async function placeAviatorBet() {
            const betAmount = parseFloat(document.getElementById('aviator-bet-amount').value);
            if (isNaN(betAmount) || betAmount < adminConfig.aviatorMinBet || betAmount > adminConfig.aviatorMaxBet) { showPopup("Invalid Bet", `Bet must be between $${adminConfig.aviatorMinBet} and $${adminConfig.aviatorMaxBet}.`); return; }
            if (betAmount > userData.balance) { showPopup("Insufficient Funds", "Not enough balance."); return; }

            await updateUserBalance(-betAmount, 'games', 'Aviator bet');
            betBtn.disabled = true; betBtn.textContent = "Flying..."; cashoutBtn.disabled = false; statusEl.classList.add('hidden');
            
            gameRunning = true; crashed = false; multiplier = 1.00; plane = { x: 20, y: canvas.height - 30 }; crashMultiplier = getCrashPoint();
            setTimeout(() => { aviatorLoop(); }, 1000);
        }

        async function cashoutAviator() {
            if (!gameRunning || crashed) return;
            gameRunning = false; cancelAnimationFrame(animationFrameId);
            
            const betAmount = parseFloat(document.getElementById('aviator-bet-amount').value);
            const winnings = betAmount * multiplier;
            await updateUserBalance(winnings, 'games', `Aviator cashout`);
            
            cashoutBtn.disabled = true; betBtn.disabled = false; betBtn.textContent = "Place Bet";
            showPopup("You Won!", `Cashed out at ${multiplier.toFixed(2)}x and won $${winnings.toFixed(2)}!`);
        }

        // --- HELPERS & UTILITIES ---
        function getAdsWatchedToday() {
            if (!userData.tasks?.lastAdWatchedAt) return 0;
            const lastAdDate = userData.tasks.lastAdWatchedAt.toDate(); const today = new Date();
            if (lastAdDate.toDateString() === today.toDateString()) return userData.tasks.adsWatchedToday || 0;
            return 0;
        }
        function hasClaimedDailyBonus() {
             if (!userData.tasks?.dailyClaimedAt) return false;
             return userData.tasks.dailyClaimedAt.toDate().toDateString() === new Date().toDateString();
        }
        async function updateUserBalance(amount, type, description) {
            const userRef = doc(db, "users", telegramId);
            const updateData = { balance: (userData.balance || 0) + amount };
            if (type) { updateData[`earnings.${type}`] = (userData.earnings?.[type] || 0) + amount; }
            await updateDoc(userRef, updateData);
        }
        function listenToWithdrawals(){/* Unchanged from original */}
        function listenToTopWithdrawers(){/* Unchanged from original */}

        window.addEventListener('load', () => { initApp(); createWheel(); drawPlane(); });
    </script>
</body>
</html>

